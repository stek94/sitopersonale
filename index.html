<!doctype html> <html lang="it"> <head> <meta charset="utf-8" /> <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" /> <title>Missioni di Coppia</title> <meta name="color-scheme" content="light dark" /> <meta name="theme-color" content="#F7F8FF" /> <style> :root{ /* LIGHT */ --bg0:#F7F8FF; --bg1:#FFFFFF; --surface: rgba(255,255,255,.78); --surface2: rgba(255,255,255,.92); --stroke: rgba(20,24,40,.10); --stroke2: rgba(20,24,40,.14); --text:#0C1020; --muted:rgba(12,16,32,.74); --muted2:rgba(12,16,32,.56); --primary:#4F7CFF; --primary2:#64D2FF; --ok:#14B8A6; --warn:#F59E0B; --bad:#EF4444; --shadow1:0 8px 22px rgba(16,24,40,.08); --shadow2:0 16px 48px rgba(16,24,40,.12); --ring:0 0 0 4px rgba(79,124,255,.16); --radius:18px; --radius2:14px; --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; } html[data-theme="dark"]{ --bg0:#070A12; --bg1:#0B1020; --surface: rgba(255,255,255,.06); --surface2: rgba(255,255,255,.08); --stroke: rgba(255,255,255,.12); --stroke2: rgba(255,255,255,.16); --text:#EAF0FF; --muted:rgba(234,240,255,.78); --muted2:rgba(234,240,255,.62); --shadow1:0 10px 26px rgba(0,0,0,.28); --shadow2:0 18px 60px rgba(0,0,0,.40); --ring:0 0 0 4px rgba(111,230,255,.16); --primary:#6A8CFF; --primary2:#6FE6FF; } *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; } html,body{ height:100%; } body{ margin:0; font-family:var(--font); color:var(--text); background: radial-gradient(900px 520px at 10% -10%, rgba(79,124,255,.18), transparent 55%), radial-gradient(780px 480px at 95% 0%, rgba(100,210,255,.20), transparent 55%), radial-gradient(820px 540px at 30% 110%, rgba(20,184,166,.12), transparent 60%), linear-gradient(180deg, var(--bg0), var(--bg1)); overflow-x:hidden; } .wrap{ max-width: 1040px; margin:0 auto; padding: 16px 16px calc(98px + env(safe-area-inset-bottom)); } header{ position: sticky; top: 0; z-index: 30; display:flex; align-items:center; justify-content:space-between; gap:12px; padding: 12px 0 14px; background: linear-gradient(180deg, color-mix(in srgb, var(--bg0) 85%, transparent), color-mix(in srgb, var(--bg0) 55%, transparent)); backdrop-filter: blur(12px); } .brand{ display:flex; gap:12px; align-items:center; min-width: 0; } .logo{ width:40px; height:40px; border-radius: 16px; background: radial-gradient(circle at 30% 30%, color-mix(in srgb, var(--primary) 35%, transparent), transparent 60%), radial-gradient(circle at 75% 70%, color-mix(in srgb, var(--primary2) 35%, transparent), transparent 60%), color-mix(in srgb, var(--surface2) 80%, transparent); border:1px solid var(--stroke); box-shadow: var(--shadow1); flex: 0 0 auto; } .title{ min-width:0; } .title h1{ margin:0; font-size:16px; letter-spacing:.2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; } .title .sub{ margin-top:2px; font-size:12px; color:var(--muted2); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; } .topActions{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; } .card{ background: var(--surface2); border:1px solid var(--stroke); border-radius: var(--radius); box-shadow: var(--shadow2); padding:14px; margin:14px 0; backdrop-filter: blur(10px); } .card.soft{ background: var(--surface); border-radius: var(--radius2); box-shadow: var(--shadow1); } .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; } .right{ margin-left:auto; } .muted{ color: var(--muted); } .muted2{ color: var(--muted2); } .tiny{ font-size:12px; } .h2{ margin:0; font-size:16px; } .h3{ margin:0; font-size:14px; } .hr{ height:1px; background: color-mix(in srgb, var(--text) 10%, transparent); margin: 12px 0; } .grid{ display:grid; gap:12px; } @media (min-width: 900px){ .grid.cols2{ grid-template-columns: 1fr 1fr; } } label{ display:block; font-size:12px; color: var(--muted); margin: 10px 0 6px; } input[type="text"], input[type="number"], select, textarea{ width:100%; border-radius: 14px; padding: 12px 12px; border: 1px solid color-mix(in srgb, var(--text) 12%, transparent); background: color-mix(in srgb, var(--surface2) 90%, transparent); color: var(--text); outline:none; transition: box-shadow .16s ease, transform .16s ease, border-color .16s ease; } input:focus, select:focus, textarea:focus{ border-color: color-mix(in srgb, var(--primary) 35%, transparent); box-shadow: var(--ring); transform: translateY(-1px); } textarea{ min-height: 96px; resize: vertical; } .btn{ border-radius: 14px; padding: 11px 12px; font-weight: 800; font-size: 13px; color: var(--text); background: color-mix(in srgb, var(--text) 4%, transparent); border: 1px solid color-mix(in srgb, var(--text) 10%, transparent); cursor:pointer; transition: transform .12s ease, box-shadow .12s ease, background .12s ease, border-color .12s ease; user-select:none; white-space:nowrap; } .btn:hover{ transform: translateY(-1px); box-shadow: var(--shadow1); background: color-mix(in srgb, var(--text) 6%, transparent); } .btn:active{ transform: translateY(0px); box-shadow:none; } .btn:focus-visible{ outline:none; box-shadow: var(--ring), var(--shadow1); } .btn[disabled]{ opacity:.55; cursor:not-allowed; transform:none; box-shadow:none; } .btn.primary{ color:white; background: linear-gradient(135deg, var(--primary), var(--primary2)); border-color: color-mix(in srgb, var(--primary) 22%, transparent); box-shadow: 0 10px 26px color-mix(in srgb, var(--primary) 22%, transparent); } .btn.danger{ color:white; background: linear-gradient(135deg, color-mix(in srgb, var(--bad) 92%, transparent), color-mix(in srgb, var(--warn) 55%, transparent)); border-color: color-mix(in srgb, var(--bad) 18%, transparent); } .btn.ghost{ background:transparent; } .pillbox{ display:flex; gap:8px; flex-wrap:wrap; } .pill{ padding: 9px 10px; border-radius: 999px; border: 1px solid color-mix(in srgb, var(--text) 10%, transparent); background: color-mix(in srgb, var(--surface2) 88%, transparent); font-size: 12px; cursor:pointer; transition: transform .12s ease, box-shadow .12s ease, background .12s ease, border-color .12s ease; } .pill:hover{ transform: translateY(-1px); box-shadow: var(--shadow1); } .pill.on{ border-color: color-mix(in srgb, var(--primary) 35%, transparent); background: color-mix(in srgb, var(--primary) 12%, transparent); } .badge{ display:inline-flex; gap:6px; align-items:center; padding: 7px 10px; border-radius: 999px; border: 1px solid color-mix(in srgb, var(--text) 10%, transparent); background: color-mix(in srgb, var(--surface2) 88%, transparent); font-size: 12px; color: var(--muted); max-width: 100%; } .badge .cut{ overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width: 320px; } .dot{ width:8px; height:8px; border-radius:999px; background: color-mix(in srgb, var(--text) 22%, transparent); } .dot.ok{ background: color-mix(in srgb, var(--ok) 95%, transparent); } .dot.warn{ background: color-mix(in srgb, var(--warn) 95%, transparent); } .dot.bad{ background: color-mix(in srgb, var(--bad) 95%, transparent); } .status{ font-weight: 900; letter-spacing:.3px; } .status.proposed{ color: var(--warn); } .status.active{ color: var(--ok); } .status.skipped{ color: var(--bad); } .status.completed{ color: var(--primary); } .toast{ position: fixed; left: 50%; bottom: calc(86px + env(safe-area-inset-bottom)); transform: translateX(-50%); min-width: min(560px, calc(100vw - 28px)); background: color-mix(in srgb, var(--surface2) 92%, transparent); border: 1px solid var(--stroke); border-radius: 14px; padding: 10px 12px; box-shadow: var(--shadow2); display:none; z-index: 90; } .bottomNav{ position: fixed; left: 50%; bottom: calc(14px + env(safe-area-inset-bottom)); transform: translateX(-50%); width: min(920px, calc(100vw - 24px)); background: color-mix(in srgb, var(--surface2) 78%, transparent); border: 1px solid var(--stroke); border-radius: 20px; padding: 10px; display:flex; gap:8px; justify-content:space-between; backdrop-filter: blur(14px); box-shadow: var(--shadow2); z-index: 50; } .tab{ flex: 1; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:4px; padding: 10px 8px; border-radius: 14px; border: 1px solid transparent; background: transparent; color: var(--muted2); cursor:pointer; transition: background .12s ease, border-color .12s ease; font-weight: 900; font-size: 11px; user-select:none; } .tab:hover{ background: color-mix(in srgb, var(--text) 5%, transparent); } .tab.on{ background: color-mix(in srgb, var(--primary) 12%, transparent); border-color: color-mix(in srgb, var(--primary) 22%, transparent); color: var(--text); } .icon{ width:18px; height:18px; opacity:.92; display:inline-block; } .table{ width:100%; border-collapse:collapse; font-size:13px; } .table th, .table td{ padding: 10px 8px; border-bottom: 1px solid color-mix(in srgb, var(--text) 10%, transparent); vertical-align: top; } .table th{ font-size:12px; color: var(--muted2); text-align:left; } .callout{ border: 1px solid color-mix(in srgb, var(--primary) 18%, transparent); background: color-mix(in srgb, var(--primary) 8%, transparent); border-radius: 16px; padding: 12px; color: color-mix(in srgb, var(--text) 86%, transparent); } /* ====== FIX LAYOUT MISSIONE (grid responsive) ====== */ .missionGrid{ display:grid; gap:12px; grid-template-columns: 1fr; align-items:start; } @media (min-width: 980px){ .missionGrid{ grid-template-columns: 1.15fr 0.85fr; } } .missionTitle{ margin-top:8px; font-size:18px; letter-spacing:.2px; line-height:1.15; } .missionDesc{ margin-top:8px; line-height:1.45; font-size:14px; color: var(--muted); } .metaWrap{ display:flex; flex-wrap:wrap; gap:8px; margin-top:12px; } .metaWrap .badge{ max-width: 100%; } .tagText{ max-width: 100%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; } .toolbarRow{ display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; } /* Favorite */ .iconBtn{ display:inline-flex; align-items:center; justify-content:center; gap:8px; padding: 10px 12px; border-radius: 14px; border:1px solid color-mix(in srgb, var(--text) 10%, transparent); background: color-mix(in srgb, var(--text) 4%, transparent); cursor:pointer; font-weight:900; color: var(--text); transition: transform .12s ease, box-shadow .12s ease; } .iconBtn:hover{ transform: translateY(-1px); box-shadow: var(--shadow1); } .star{ width:18px; height:18px; } .starFill{ fill: color-mix(in srgb, var(--warn) 88%, transparent); } .starEmpty{ fill: none; stroke: currentColor; stroke-width: 1.8; } /* Pages + micro-animazioni */ .page{ display:none; } .page.on{ display:block; animation: pageIn .18s ease-out; } @keyframes pageIn{ from{ opacity:0; transform: translateY(6px); } to{ opacity:1; transform: translateY(0); } } @media (prefers-reduced-motion: reduce){ .page.on{ animation:none; } .btn,.pill,.tab,.iconBtn,input,textarea,select{ transition:none !important; } } /* Wizard */ .wizardOverlay{ position: fixed; inset: 0; z-index: 100; display:none; background: radial-gradient(900px 520px at 10% -10%, color-mix(in srgb, var(--primary) 20%, transparent), transparent 55%), radial-gradient(780px 480px at 95% 0%, color-mix(in srgb, var(--primary2) 22%, transparent), transparent 55%), linear-gradient(180deg, color-mix(in srgb, var(--bg0) 96%, transparent), color-mix(in srgb, var(--bg1) 96%, transparent)); overflow: auto; padding: 18px 16px calc(18px + env(safe-area-inset-bottom)); } .wizardShell{ max-width: 820px; margin: 0 auto; } .wizardTop{ display:flex; align-items:flex-start; justify-content:space-between; gap:12px; margin-bottom: 12px; } .wizTitle{ margin:0; font-size:18px; letter-spacing:.2px; } .wizSub{ margin-top:4px; font-size:12px; color: var(--muted2); } .wizProg{ display:flex; align-items:center; gap:8px; flex: 0 0 auto; } .wizDot{ width:10px; height:10px; border-radius:999px; background: color-mix(in srgb, var(--text) 16%, transparent); } .wizDot.on{ background: color-mix(in srgb, var(--primary) 85%, transparent); } .wizDot.done{ background: color-mix(in srgb, var(--ok) 95%, transparent); } .wizCard{ background: color-mix(in srgb, var(--surface2) 92%, transparent); border: 1px solid var(--stroke); border-radius: 20px; box-shadow: var(--shadow2); padding: 14px; } .wizStep{ display:none; } .wizStep.on{ display:block; } .wizFooter{ position: sticky; bottom: 0; margin-top: 12px; padding-top: 12px; background: linear-gradient(180deg, rgba(0,0,0,0), color-mix(in srgb, var(--surface2) 92%, transparent) 35%, color-mix(in srgb, var(--surface2) 96%, transparent)); backdrop-filter: blur(12px); } .wizFooterInner{ display:flex; gap:10px; align-items:center; justify-content:space-between; } details{ border: 1px solid var(--stroke); background: color-mix(in srgb, var(--surface2) 86%, transparent); border-radius: 16px; padding: 10px 12px; box-shadow: var(--shadow1); } summary{ cursor:pointer; font-weight: 900; color: color-mix(in srgb, var(--text) 86%, transparent); list-style: none; } summary::-webkit-details-marker{ display:none; } /* History toolbar */ .filters{ display:grid; grid-template-columns: 1fr; gap:10px; margin-top: 10px; } @media (min-width: 900px){ .filters{ grid-template-columns: 1.4fr .8fr .8fr; align-items:end; } } .switch{ display:flex; gap:10px; align-items:center; padding: 10px 12px; border:1px solid var(--stroke); border-radius: 14px; background: color-mix(in srgb, var(--surface2) 86%, transparent); } .switch input{ width:18px; height:18px; } </style> </head> <body> <!-- Wizard Overlay --> <div id="wizard" class="wizardOverlay" aria-modal="true" role="dialog"> <div class="wizardShell"> <div class="wizardTop"> <div style="min-width:0;"> <div class="row" style="gap:10px; align-items:center;"> <div class="logo"></div> <div> <h2 class="wizTitle">Benvenuti in Missioni di Coppia</h2> <div class="wizSub">Onboarding rapido • Dati locali • Sync manuale</div> </div> </div> </div> <div class="wizProg" aria-label="Progresso"> <div class="wizDot" id="dot1"></div> <div class="wizDot" id="dot2"></div> <div class="wizDot" id="dot3"></div> <div class="wizDot" id="dot4"></div> </div> </div> <div class="wizCard"> <div class="wizStep" id="wiz1"> <div class="row"> <h3 class="h2">1) Sicurezza & privacy</h3> <span class="right badge"><span class="dot warn"></span><span class="tiny">Richiesto</span></span> </div> <div class="callout" style="margin-top:10px;"> Missioni romantiche/intime (non esplicite). Consenso sempre revocabile. Nessun backend: i dati restano sul dispositivo. </div> <div style="margin-top:10px;"> <label style="margin:0; display:flex; gap:10px; align-items:flex-start;"> <input type="checkbox" id="wizChk18" /> <span> Confermo 18+ e uso consensuale. <div class="tiny muted2">“No” e “stop” sono sempre validi.</div> </span> </label> <div style="height:10px"></div> <label style="margin:0; display:flex; gap:10px; align-items:flex-start;"> <input type="checkbox" id="wizChkPrivacy" /> <span>Ho capito che i dati restano in questo browser (localStorage).</span> </label> </div> </div> <div class="wizStep" id="wiz2"> <div class="row"> <h3 class="h2">2) Il tuo profilo</h3> <span class="right badge"><span class="dot warn"></span><span class="tiny">Richiesto</span></span> </div> <div class="grid cols2" style="margin-top:10px;"> <div> <label>Nickname</label> <input type="text" id="wizMeName" placeholder="Es. Alex" /> </div> <div> <label>Pronomi (facoltativo)</label> <input type="text" id="wizMePron" placeholder="Es. lui/lei/loro" /> </div> </div> <div class="grid cols2"> <div> <label>Intensità massima (1–5)</label> <input type="number" id="wizMeInt" min="1" max="5" /> <div class="tiny muted2" style="margin-top:6px;">Consiglio: scegli un valore realistico. Verrà usato come cap.</div> </div> <div> <label>Frequenza desiderata</label> <select id="wizMeFreq"> <option value="bassa">Bassa</option> <option value="media">Media</option> <option value="alta">Alta</option> </select> <div class="tiny muted2" style="margin-top:6px;">Per ora è salvata nel profilo (può essere usata in future estensioni).</div> </div> </div> </div> <div class="wizStep" id="wiz3"> <div class="row"> <h3 class="h2">3) Preferenze</h3> <span class="right badge"><span class="dot ok"></span><span class="tiny">Consigliato</span></span> </div> <div class="grid cols2" style="margin-top:10px;"> <div class="card soft" style="margin:0;"> <div class="row"> <div class="h3">Interessi</div> <span class="right tiny muted2">Seleziona</span> </div> <div class="tiny muted2" style="margin:6px 0 10px;">Aiuta a rendere le missioni più “vostre”.</div> <div class="pillbox" id="wizInterests"></div> </div> <div class="card soft" style="margin:0;"> <div class="row"> <div class="h3">Hard limits (mai)</div> <span class="right tiny muted2">Seleziona</span> </div> <div class="tiny muted2" style="margin:6px 0 10px;">Vengono esclusi dalla selezione missioni.</div> <div class="pillbox" id="wizLimits"></div> </div> </div> <label>Note (facoltativo)</label> <textarea id="wizMeNotes" placeholder="Es. preferisco missioni in casa / niente sorprese fuori..."></textarea> </div> <div class="wizStep" id="wiz4"> <div class="row"> <h3 class="h2">4) Coppia & Sync</h3> <span class="right badge"><span class="dot warn"></span><span class="tiny">Richiesto</span></span> </div> <div class="callout" style="margin-top:10px;"> Inserite lo stesso <strong>Codice Coppia</strong> su entrambi i dispositivi. Serve per generare la stessa missione. </div> <label>Codice Coppia (condiviso)</label> <input type="text" id="wizCoupleCode" placeholder="Es. NOSTRA-COPPIA-2025" /> <div class="row" style="margin-top:10px;"> <button class="btn" id="wizGenCode">Genera codice casuale</button> <span class="tiny muted2">Poi condividetelo e usatelo su entrambi i dispositivi.</span> </div> <div class="hr"></div> <details> <summary>Opzionale: importa già il Sync del partner</summary> <div class="tiny muted2" style="margin-top:8px;"> Se hai già il testo “MC2:…”, incollalo qui. Deve avere lo stesso Codice Coppia. </div> <label>Incolla Sync partner</label> <textarea id="wizPartnerSync" placeholder="MC2:..."></textarea> <div class="row" style="margin-top:10px;"> <button class="btn primary" id="wizImportPartner">Importa partner</button> <span class="tiny muted2" id="wizPartnerImportState">—</span> </div> </details> </div> <div class="wizFooter"> <div class="wizFooterInner"> <button class="btn" id="wizBack">Indietro</button> <div class="tiny muted2" id="wizHint">—</div> <button class="btn primary" id="wizNext">Avanti</button> </div> </div> </div> <div class="tiny muted2" style="margin-top:10px; text-align:center;"> Puoi rifare l’onboarding in qualsiasi momento da <strong>Sync</strong>. </div> </div> </div> <div class="wrap"> <header> <div class="brand"> <div class="logo"></div> <div class="title"> <h1>Missioni di Coppia</h1> <div class="sub" id="headerSub">Oggi • Storico • Sync</div> </div> </div> <div class="topActions"> <button class="btn ghost" id="btnQuickShare">Condividi Sync</button> <button class="btn ghost" id="btnQuickImport">Importa</button> </div> </header> <div id="toast" class="toast"></div> <!-- DASH --> <section id="pageDash" class="card page"> <div class="toolbarRow"> <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;"> <h2 class="h2" style="margin:0;">Oggi</h2> <span class="badge"><span class="dot" id="dashDot"></span><span id="dashMeta" class="cut">—</span></span> </div> <button class="iconBtn" id="btnFavToday" title="Preferita"> <svg class="star" viewBox="0 0 24 24" aria-hidden="true"> <path id="favPath" class="starEmpty" d="M12 3.2l2.6 5.6 6.1.9-4.4 4.3 1 6.1-5.3-2.9-5.3 2.9 1-6.1-4.4-4.3 6.1-.9L12 3.2z"/> </svg> Preferita </button> </div> <div class="card soft" id="missionCard"> <div class="missionGrid"> <!-- LEFT --> <div> <div class="tiny muted2">Missione di oggi</div> <h3 class="missionTitle" id="mTitle">—</h3> <div class="missionDesc" id="mDesc">—</div> <div class="metaWrap"> <span class="badge" id="mIntensity"><span class="dot"></span> Intensità: —</span> <span class="badge" id="mDuration"><span class="dot"></span> Durata: —</span> <span class="badge" id="mTags"><span class="dot"></span> <span class="tagText">Tag: —</span></span> </div> <div class="row" style="margin-top:12px;"> <span class="status proposed" id="mStatus">PROPOSED</span> <span class="tiny muted2" id="mStatusHint"></span> </div> </div> <!-- RIGHT --> <div> <div class="card soft" style="margin:0;"> <div class="row"> <div class="tiny muted2">Stato</div> <span class="right tiny muted2" id="syncStamp">Sync: —</span> </div> <div class="hr"></div> <div class="row"> <span class="badge" id="myState"><span class="dot warn"></span> Io: non accettata</span> <span class="badge" id="partnerStateToday"><span class="dot warn"></span> Partner: sconosciuto</span> </div> <div class="hr"></div> <div class="row"> <button class="btn primary" id="btnAcceptToggle">Accetta</button> <button class="btn" id="btnReplace">Sostituisci</button> <button class="btn danger" id="btnSkip">Salta</button> </div> <div class="hr"></div> <div class="row"> <button class="btn primary right" id="btnComplete" disabled>Completata</button> </div> <div class="tiny muted2" style="margin-top:10px;"> Per vedere lo stato del partner, importa il suo Sync in <strong>Sync</strong>. </div> </div> </div> </div> </div> <div class="card soft" id="completeCard" style="display:none;"> <div class="row"> <h3 class="h3">Feedback (solo tuo)</h3> <span class="right tiny muted2">Puoi scegliere cosa includere nel Sync</span> </div> <div class="grid cols2"> <div> <label>Rating (1–5)</label> <input type="number" id="cRate" min="1" max="5" /> </div> <div> <label>Note (facoltativo)</label> <input type="text" id="cNote" placeholder="Es. bella, rifarei / troppo lunga / preferisco altro..." /> </div> </div> <div class="row" style="margin-top:10px;"> <button class="btn primary" id="btnSaveCompletion">Salva</button> <button class="btn" id="btnCancelCompletion">Annulla</button> </div> </div> <div class="card soft" id="dashWarnings" style="display:none;"></div> </section> <!-- HISTORY --> <section id="pageHistory" class="card page"> <div class="row"> <h2 class="h2">Storico</h2> <span class="right tiny muted2">Su questo dispositivo</span> </div> <div class="filters"> <div> <label>Cerca</label> <input type="text" id="histQuery" placeholder="Titolo o tag..." /> </div> <div> <label>Stato</label> <select id="histStatus"> <option value="all">Tutti</option> <option value="proposed">Proposed</option> <option value="active">Active</option> <option value="completed">Completed</option> <option value="skipped">Skipped</option> </select> </div> <div class="switch"> <input type="checkbox" id="histFavOnly" /> <div> <div style="font-weight:900;">Solo preferite</div> <div class="tiny muted2">Filtra per stelle</div> </div> </div> </div> <div class="card soft" style="margin-top:12px;"> <table class="table"> <thead> <tr><th></th><th>Data</th><th>Missione</th><th>Stato</th><th>Rating</th></tr> </thead> <tbody id="historyBody"></tbody> </table> </div> </section> <!-- SETTINGS / SYNC --> <section id="pageSettings" class="card page"> <div class="row"> <h2 class="h2">Sync</h2> <span class="right tiny muted2">Copia/incolla</span> </div> <div class="grid cols2"> <div class="card soft"> <h3 class="h3">Il mio Sync code</h3> <div class="tiny muted2" style="margin-top:6px;"> Invia questo testo al partner. Contiene preferenze e stato di oggi (e storico recente). </div> <label style="display:flex; gap:10px; align-items:center; margin-top:10px;"> <input type="checkbox" id="chkShareNotes" /> <span class="tiny muted">Includi note nel Sync</span> </label> <div class="row" style="margin-top:8px;"> <button class="btn primary" id="btnBuildSync">Genera</button> <button class="btn" id="btnCopySync">Copia</button> <button class="btn" id="btnShareSync">Condividi…</button> </div> <label>Sync code</label> <textarea id="outSync" placeholder="Clicca 'Genera'"></textarea> </div> <div class="card soft"> <h3 class="h3">Importa Sync partner</h3> <div class="tiny muted2" style="margin-top:6px;"> Incolla qui il testo ricevuto dal partner. Deve avere lo stesso <strong>Codice Coppia</strong>. </div> <label>Incolla Sync code</label> <textarea id="inSync" placeholder="MC2:..."></textarea> <div class="row" style="margin-top:10px;"> <button class="btn primary" id="btnImportSync">Importa</button> <button class="btn" id="btnClearIn">Pulisci</button> </div> <div class="hr"></div> <h3 class="h3">Backup locale</h3> <div class="row" style="margin-top:8px;"> <button class="btn" id="btnExport">Export JSON</button> <button class="btn danger" id="btnReset">Reset</button> </div> </div> </div> <div class="hr"></div> <div class="card soft"> <div class="row"> <h3 class="h3">Tema</h3> <span class="right tiny muted2">Light / Dark</span> </div> <div class="row" style="margin-top:10px;"> <button class="btn" id="btnThemeAuto">Auto</button> <button class="btn" id="btnThemeLight">Light</button> <button class="btn" id="btnThemeDark">Dark</button> <span class="right tiny muted2" id="themeState">—</span> </div> </div> <div class="card soft"> <div class="row"> <h3 class="h3">Profilo & Preferenze</h3> <span class="right badge"><span class="dot ok"></span><span id="profileMeta">—</span></span> </div> <div class="grid cols2" style="margin-top:10px;"> <div> <label>Nickname</label> <input type="text" id="setMeName" /> </div> <div> <label>Pronomi</label> <input type="text" id="setMePron" /> </div> <div> <label>Intensità massima (1–5)</label> <input type="number" id="setMeInt" min="1" max="5" /> </div> <div> <label>Frequenza</label> <select id="setMeFreq"> <option value="bassa">Bassa</option> <option value="media">Media</option> <option value="alta">Alta</option> </select> </div> </div> <label>Codice Coppia</label> <input type="text" id="setCoupleCode" /> <div class="grid cols2" style="margin-top:10px;"> <div class="card soft" style="margin:0;"> <div class="row"><div class="h3">Interessi</div><span class="right tiny muted2">Tocca per selezionare</span></div> <div class="pillbox" id="setInterests" style="margin-top:10px;"></div> </div> <div class="card soft" style="margin:0;"> <div class="row"><div class="h3">Hard limits</div><span class="right tiny muted2">Tocca per selezionare</span></div> <div class="pillbox" id="setLimits" style="margin-top:10px;"></div> </div> </div> <label>Note</label> <textarea id="setMeNotes"></textarea> <div class="row" style="margin-top:10px;"> <button class="btn primary" id="btnSaveProfile">Salva modifiche</button> <button class="btn" id="btnRerunWizard">Rifai onboarding</button> <span class="tiny muted2 right" id="profileSaveState">—</span> </div> </div> </section> </div> <div class="bottomNav" id="bottomNav" style="display:none;"> <button class="tab" id="tabToday" title="Oggi"> <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M7 3v3M17 3v3M4 8h16M6 12h5M6 16h7" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/></svg> Oggi </button> <button class="tab" id="tabHistory" title="Storico"> <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M12 8v5l3 2M4 12a8 8 0 1 0 2.3-5.7" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/></svg> Storico </button> <button class="tab" id="tabSync" title="Sync"> <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M10 13a5 5 0 0 1 0-7l1-1a5 5 0 0 1 7 7l-1 1M14 11a5 5 0 0 1 0 7l-1 1a5 5 0 0 1-7-7l1-1" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/></svg> Sync </button> </div> <script> // ---------------------------- // Tags + templates (safe) // ---------------------------- const TAGS = [ { id:"romantico", label:"Romantico" }, { id:"comunicazione", label:"Comunicazione" }, { id:"sensoriale", label:"Sensoriale" }, { id:"gioco", label:"Gioco/leggerezza" }, { id:"cura", label:"Cura/attenzione" }, { id:"sorpresa", label:"Sorpresa" }, { id:"appuntamento", label:"Mini-appuntamento" }, { id:"coccole", label:"Coccole" }, { id:"massaggio", label:"Massaggio" }, { id:"gratitudine", label:"Gratitudine" }, { id:"slow", label:"Slow time" }, { id:"avventura", label:"Piccola avventura" } ]; const TEMPLATES = [ { id:"t01", title:"Check-in di 5 minuti", desc:"Sedetevi vicini e condividete: una cosa bella di oggi e una cosa che vi serve domani. Ascolto senza interrompere.", tags:["comunicazione","cura"], intensity:1, duration:5 }, { id:"t02", title:"Tre apprezzamenti", desc:"A turno: dite 3 cose specifiche che avete apprezzato dell’altro oggi (azioni, dettagli, parole).", tags:["gratitudine","romantico"], intensity:1, duration:7 }, { id:"t03", title:"Playlist e presenza", desc:"Mettete una canzone “vostra” e restate abbracciati fino alla fine, senza telefoni.", tags:["romantico","slow","coccole"], intensity:1, duration:6 }, { id:"t04", title:"Coccole guidate", desc:"10 minuti di coccole con una regola: chi riceve guida (“più vicino”, “più lento”, “così va bene”).", tags:["coccole","comunicazione","slow"], intensity:2, duration:10 }, { id:"t05", title:"Massaggio a turno", desc:"Massaggio alle spalle o mani per 8 minuti a turno, con pressione concordata e stop immediato se serve.", tags:["massaggio","sensoriale","cura"], intensity:2, duration:16 }, { id:"t06", title:"Mini-appuntamento in casa", desc:"Bevanda semplice + 20 minuti di conversazione come al primo appuntamento: domande curiose, niente logistica.", tags:["appuntamento","romantico","comunicazione"], intensity:2, duration:25 }, { id:"t07", title:"Biglietto segreto", desc:"Scrivete un messaggio breve con un desiderio romantico per la settimana e scambiatelo.", tags:["romantico","gratitudine"], intensity:1, duration:8 }, { id:"t08", title:"Rituale di fine giornata", desc:"Create un micro-rituale: bacio + frase “oggi ti porto con me perché…” (1 minuto ciascuno).", tags:["romantico","coccole"], intensity:1, duration:4 }, { id:"t09", title:"Passeggiata senza schermi", desc:"10–20 minuti fuori (o sul balcone): camminate e raccontate un ricordo bello insieme.", tags:["avventura","romantico","comunicazione"], intensity:2, duration:15 }, { id:"t10", title:"Sorpresa gentile", desc:"Uno prepara una piccola sorpresa non materiale (una canzone, una frase, un gesto) e la consegna stasera.", tags:["sorpresa","romantico"], intensity:2, duration:10 }, { id:"t11", title:"Domande “noi”", desc:"Rispondete a 3 domande: cosa ti fa sentire amato? cosa ti scarica stress? cosa vorresti più spesso?", tags:["comunicazione","cura"], intensity:2, duration:12 }, { id:"t12", title:"Gioco: 2 verità e un desiderio", desc:"A turno: 2 verità su di te e 1 desiderio romantico realistico per questa settimana.", tags:["gioco","comunicazione","romantico"], intensity:2, duration:12 }, { id:"t13", title:"Cura pratica", desc:"Fai una piccola cosa pratica per l’altro oggi. Poi dite “grazie” guardandovi negli occhi.", tags:["cura","gratitudine"], intensity:1, duration:10 }, { id:"t14", title:"Respirare insieme", desc:"Seduti vicini, respirate lentamente sincronizzati per 3 minuti. Poi un abbraccio di 30 secondi.", tags:["slow","coccole","cura"], intensity:1, duration:5 }, { id:"t15", title:"Complimenti mirati", desc:"Scegli un tratto dell’altro e dì perché lo stimi davvero (specifico, concreto).", tags:["gratitudine","comunicazione"], intensity:1, duration:7 }, { id:"t16", title:"Micro-sfida: tono costruttivo", desc:"Per 20 minuti: solo comunicazione costruttiva. Se serve, chiedi pausa. Chiudete con un “grazie per lo sforzo”.", tags:["comunicazione","cura"], intensity:2, duration:20 }, { id:"t17", title:"Racconto a occhi chiusi", desc:"Uno racconta un ricordo bello, l’altro ascolta a occhi chiusi e poi ripete una frase che ha colpito.", tags:["comunicazione","slow"], intensity:2, duration:10 }, { id:"t18", title:"Sguardo e sorriso", desc:"Per 60 secondi guardatevi negli occhi e sorridete. Se scappa da ridere, va benissimo.", tags:["romantico","gioco"], intensity:1, duration:2 }, { id:"t19", title:"Merenda “tema”", desc:"Scegliete un tema (anni ’90, cinema, Italia…) e fate una micro-merenda con musica.", tags:["appuntamento","sorpresa","gioco"], intensity:2, duration:20 }, { id:"t20", title:"Massaggio mani + ringraziamento", desc:"5 minuti di massaggio alle mani, poi una frase di gratitudine specifica.", tags:["massaggio","gratitudine","sensoriale"], intensity:2, duration:12 }, { id:"t21", title:"Tocco consensuale (soft)", desc:"Per 5 minuti, tocco leggero su braccia/spalle/capelli a turno, guidato da chi riceve. Stop immediato se serve.", tags:["sensoriale","coccole","comunicazione"], intensity:3, duration:10 }, { id:"t22", title:"Serata senza schermi", desc:"30 minuti senza schermi: scegliete un’attività semplice insieme (carte, gioco, chiacchiere).", tags:["slow","gioco","appuntamento"], intensity:2, duration:30 }, { id:"t23", title:"Lista desideri di coppia", desc:"Scrivete 5 cose da fare insieme nel prossimo mese (semplici). Sceglietene 1 da pianificare.", tags:["comunicazione","avventura"], intensity:2, duration:15 }, { id:"t24", title:"Complimento “in pubblico” (soft)", desc:"Se siete in giro: un complimento gentile e breve all’altro, poi un sorriso d’intesa.", tags:["sorpresa","romantico"], intensity:2, duration:5 }, { id:"t25", title:"Aftercare: 2 minuti di tenerezza", desc:"Chiudete la giornata con 2 minuti di abbraccio e una domanda: “di cosa hai bisogno adesso?”", tags:["cura","coccole","comunicazione"], intensity:2, duration:4 } ]; const KEY = "missioniCoppia_singleDevice_v4_modern"; const KEY_THEME = "missioniCoppia_theme"; const $ = (id) => document.getElementById(id); function defaultState(){ return { flags: { onboarded: false }, setup: { consent18:false, consentPrivacy:false, coupleCode:"" }, me: { name:"", pronouns:"", intensity:2, frequency:"media", interests:[], hardLimits:[], notes:"" }, partner: null, daily: {}, favorites: [], // templateId[] createdAt: new Date().toISOString(), updatedAt: new Date().toISOString() }; } function loadState(){ const raw = localStorage.getItem(KEY); if(!raw) return defaultState(); try{ const parsed = JSON.parse(raw); parsed.flags ??= { onboarded:false }; parsed.setup ??= { consent18:false, consentPrivacy:false, coupleCode:"" }; parsed.me ??= { name:"", pronouns:"", intensity:2, frequency:"media", interests:[], hardLimits:[], notes:"" }; parsed.daily ??= {}; parsed.favorites ??= []; return parsed; }catch{ return defaultState(); } } let state = loadState(); function saveState(){ state.updatedAt = new Date().toISOString(); localStorage.setItem(KEY, JSON.stringify(state)); } // Theme function applyTheme(mode){ // mode: "auto" | "light" | "dark" if(mode === "auto"){ document.documentElement.removeAttribute("data-theme"); }else{ document.documentElement.setAttribute("data-theme", mode); } localStorage.setItem(KEY_THEME, mode); updateThemeState(); } function currentTheme(){ return localStorage.getItem(KEY_THEME) || "auto"; } function updateThemeState(){ const m = currentTheme(); $("themeState").textContent = Tema: ${m}; } // Utils function clampInt(n, min, max, fallback){ const x = Number(n); if(!Number.isFinite(x)) return fallback; return Math.max(min, Math.min(max, Math.round(x))); } function todayKey(){ const d = new Date(); const y = d.getFullYear(); const m = String(d.getMonth()+1).padStart(2,"0"); const day = String(d.getDate()).padStart(2,"0"); return ${y}-${m}-${day}; } function showToast(msg){ const t = $("toast"); t.textContent = msg; t.style.display = "block"; clearTimeout(showToast._tmr); showToast._tmr = setTimeout(()=> t.style.display="none", 2400); } function hashStringToSeed(str){ let h = 2166136261; for(let i=0;i<str.length;i++){ h ^= str.charCodeAt(i); h = Math.imul(h, 16777619); } return h >>> 0; } function mulberry32(seed){ let a = seed >>> 0; return function(){ a += 0x6D2B79F5; let t = a; t = Math.imul(t ^ (t >>> 15), t | 1); t ^= t + Math.imul(t ^ (t >>> 7), t | 61); return ((t ^ (t >>> 14)) >>> 0) / 4294967296; }; } function setupComplete(){ const s = state.setup; const me = state.me; return !!( s.consent18 && s.consentPrivacy && (me.name||"").trim().length >= 1 && (s.coupleCode||"").trim().length >= 6 && clampInt(me.intensity,1,5,0) >= 1 ); } function getTemplateById(id){ return TEMPLATES.find(t => t.id === id); } function combinedPrefs(){ const me = state.me; const p = state.partner; const intensity = p ? Math.min(clampInt(me.intensity,1,5,2), clampInt(p.intensity,1,5,2)) : clampInt(me.intensity,1,5,2); const hard = new Set([...(me.hardLimits||[]), ...(p?.hardLimits||[])]); const meI = new Set(me.interests||[]); const pI = new Set(p?.interests||[]); const overlap = p ? [...meI].filter(x => pI.has(x)) : [...meI]; const union = p ? Array.from(new Set([...meI, ...pI])) : [...meI]; return { intensity, hard, overlap, union, hasPartner: !!p }; } function scoreTemplate(t, prefs, rng){ let score = rng() * 10; const tags = new Set(t.tags); const overlapHits = prefs.overlap.filter(x => tags.has(x)).length; const unionHits = prefs.union.filter(x => tags.has(x)).length; score += overlapHits * (prefs.hasPartner ? 12 : 6); score += unionHits * 2; score += (5 - t.intensity) * 0.3; return score; } function eligibleTemplates(prefs){ return TEMPLATES.filter(t => { if(t.intensity > prefs.intensity) return false; for(const tag of t.tags) if(prefs.hard.has(tag)) return false; return true; }); } function computePickForDate(dateKey, replaceSalt){ const prefs = combinedPrefs(); const pool = eligibleTemplates(prefs); const safePool = pool.length ? pool : TEMPLATES.filter(t => t.intensity <= prefs.intensity); const days = []; const baseDate = new Date(dateKey + "T00:00:00"); for(let i=7;i>=0;i--){ const d = new Date(baseDate); d.setDate(baseDate.getDate() - i); const y = d.getFullYear(); const m = String(d.getMonth()+1).padStart(2,"0"); const day = String(d.getDate()).padStart(2,"0"); days.push(${y}-${m}-${day}); } const chosen = new Map(); const window = []; for(const dk of days){ const salt = (dk === dateKey) ? (replaceSalt || 0) : 0; let attempt = 0; let pick = null; while(attempt < 40){ const seed = hashStringToSeed(${state.setup.coupleCode}|${dk}|salt:${salt}|try:${attempt}); const rng = mulberry32(seed); let best = null; for(let i=0;i<Math.min(14, safePool.length); i++){ const idx = Math.floor(rng() * safePool.length); const t = safePool[idx]; const s = scoreTemplate(t, prefs, rng); if(!best || s > best.s) best = { t, s }; } pick = best?.t || safePool[Math.floor(rng() * safePool.length)]; if(!window.includes(pick.id)) break; attempt++; } chosen.set(dk, pick.id); window.push(pick.id); while(window.length > 7) window.shift(); } return chosen.get(dateKey); } function ensureToday(){ const k = todayKey(); if(!state.daily[k]){ state.daily[k] = { templateId: null, replaceSalt: 0, skipped: false, my: { accepted:false, completed:false, rating:null, note:"", acceptedAt:null, completedAt:null } }; } const rec = state.daily[k]; if(!rec.templateId){ rec.templateId = computePickForDate(k, rec.replaceSalt); } return rec; } function getPartnerToday(){ const k = todayKey(); const p = state.partner; if(!p) return null; return (p.daily && p.daily[k]) ? p.daily[k] : null; } // Favorites function isFav(templateId){ return (state.favorites || []).includes(templateId); } function toggleFav(templateId){ const set = new Set(state.favorites || []); if(set.has(templateId)) set.delete(templateId); else set.add(templateId); state.favorites = [...set]; saveState(); } function renderFavButton(templateId){ const fav = isFav(templateId); const path = $("favPath"); // switch between empty stroke and filled if(fav){ path.setAttribute("class", "starFill"); path.setAttribute("d", "M12 3.2l2.6 5.6 6.1.9-4.4 4.3 1 6.1-5.3-2.9-5.3 2.9 1-6.1-4.4-4.3 6.1-.9L12 3.2z"); }else{ path.setAttribute("class", "starEmpty"); path.setAttribute("d", "M12 3.2l2.6 5.6 6.1.9-4.4 4.3 1 6.1-5.3-2.9-5.3 2.9 1-6.1-4.4-4.3 6.1-.9L12 3.2z"); } } // Pills function pillSet(containerId, selectedArr, onToggle){ const el = $(containerId); if(!el) return; el.innerHTML = ""; TAGS.forEach(t=>{ const pill = document.createElement("div"); pill.className = "pill" + (selectedArr.includes(t.id) ? " on" : ""); pill.textContent = t.label; pill.onclick = ()=> onToggle(t.id); el.appendChild(pill); }); } // Wizard let wizStep = 1; function setWizardVisible(on){ $("wizard").style.display = on ? "block" : "none"; $("bottomNav").style.display = on ? "none" : "flex"; } function setDots(step){ for(let i=1;i<=4;i++){ const d = $("dot"+i); d.className = "wizDot" + (i===step ? " on" : "") + (i<step ? " done" : ""); } } function showWizardStep(step){ wizStep = step; setDots(step); for(let i=1;i<=4;i++){ $("wiz"+i).classList.toggle("on", i===step); } $("wizBack").disabled = (step===1); $("wizNext").textContent = (step===4) ? "Inizia" : "Avanti"; const hints = { 1: "Conferma requisiti di sicurezza e privacy.", 2: "Inserisci il tuo profilo.", 3: "Preferenze (consigliato).", 4: "Codice Coppia (e partner opzionale)." }; $("wizHint").textContent = hints[step] || "—"; if(step===1){ $("wizChk18").checked = !!state.setup.consent18; $("wizChkPrivacy").checked = !!state.setup.consentPrivacy; } if(step===2){ $("wizMeName").value = state.me.name || ""; $("wizMePron").value = state.me.pronouns || ""; $("wizMeInt").value = clampInt(state.me.intensity,1,5,2); $("wizMeFreq").value = state.me.frequency || "media"; } if(step===3){ $("wizMeNotes").value = state.me.notes || ""; pillSet("wizInterests", state.me.interests || [], toggleInterestWizard); pillSet("wizLimits", state.me.hardLimits || [], toggleLimitWizard); } if(step===4){ $("wizCoupleCode").value = state.setup.coupleCode || ""; $("wizPartnerImportState").textContent = state.partner ? Partner importato: ${state.partner.name||"Partner"} : "—"; } } function toggleInterestWizard(tag){ const set = new Set(state.me.interests || []); if(set.has(tag)) set.delete(tag); else set.add(tag); state.me.interests = [...set]; state.me.hardLimits = (state.me.hardLimits||[]).filter(x=>x!==tag); saveState(); pillSet("wizInterests", state.me.interests, toggleInterestWizard); pillSet("wizLimits", state.me.hardLimits, toggleLimitWizard); } function toggleLimitWizard(tag){ const set = new Set(state.me.hardLimits || []); if(set.has(tag)) set.delete(tag); else set.add(tag); state.me.hardLimits = [...set]; state.me.interests = (state.me.interests||[]).filter(x=>x!==tag); saveState(); pillSet("wizInterests", state.me.interests, toggleInterestWizard); pillSet("wizLimits", state.me.hardLimits, toggleLimitWizard); } function validateWizardStep(step){ if(step===1){ state.setup.consent18 = $("wizChk18").checked; state.setup.consentPrivacy = $("wizChkPrivacy").checked; saveState(); if(!state.setup.consent18 || !state.setup.consentPrivacy){ showToast("Conferma 18+ e privacy locale per continuare."); return false; } return true; } if(step===2){ state.me.name = $("wizMeName").value.trim(); state.me.pronouns = $("wizMePron").value.trim(); state.me.intensity = clampInt($("wizMeInt").value, 1, 5, 2); state.me.frequency = $("wizMeFreq").value; saveState(); if((state.me.name||"").length < 1){ showToast("Inserisci un nickname."); return false; } return true; } if(step===3){ state.me.notes = $("wizMeNotes").value.trim(); saveState(); return true; } if(step===4){ state.setup.coupleCode = $("wizCoupleCode").value.trim(); saveState(); if((state.setup.coupleCode||"").length < 6){ showToast("Codice Coppia: minimo 6 caratteri."); return false; } return true; } return true; } function completeOnboarding(){ if(!setupComplete()){ showToast("Onboarding incompleto. Controlla consensi, nickname, intensità e Codice Coppia."); return; } state.flags.onboarded = true; ensureToday(); saveState(); setWizardVisible(false); showToast("Fatto. Buona missione."); showPage("pageDash"); } // Pages function setTabs(active){ ["Today","History","Sync"].forEach(t=>{ const el = $("tab"+t); if(el) el.classList.toggle("on", active===t); }); } function showPage(pageId){ const pages = ["pageDash","pageHistory","pageSettings"]; for(const p of pages) $(p).classList.toggle("on", p===pageId); if(pageId==="pageDash"){ setTabs("Today"); renderDash(); } if(pageId==="pageHistory"){ setTabs("History"); renderHistory(); } if(pageId==="pageSettings"){ setTabs("Sync"); renderSettings(); renderSettingsProfile(); } } // Render function renderDash(){ $("dashWarnings").style.display = "none"; if(!setupComplete()){ $("dashWarnings").style.display = "block"; $("dashWarnings").innerHTML = <strong>Configurazione incompleta.</strong> Apri l’onboarding da Sync → Rifai onboarding.; $("dashMeta").textContent = "Setup incompleto"; $("dashDot").className = "dot warn"; return; } const k = todayKey(); const rec = ensureToday(); const tpl = getTemplateById(rec.templateId); const who = ${state.me.name || "Io"}${state.partner ? " + " + (state.partner.name||"Partner") : ""}; $("dashMeta").textContent = ${k} • ${who}; $("dashDot").className = "dot ok"; $("mTitle").textContent = tpl?.title || "—"; $("mDesc").textContent = tpl?.desc || "—"; $("mIntensity").innerHTML = <span class="dot"></span> Intensità: ${tpl?.intensity ?? "—"}; $("mDuration").innerHTML = <span class="dot"></span> Durata: ~${tpl?.duration ?? "—"} min; $("mTags").innerHTML = <span class="dot"></span> <span class="tagText">Tag: ${(tpl?.tags||[]).join(", ") || "—"}</span>; let status = "proposed"; if(rec.skipped) status = "skipped"; else if(rec.my.completed) status = "completed"; else if(rec.my.accepted) status = "active"; const sEl = $("mStatus"); sEl.textContent = status.toUpperCase(); sEl.className = "status " + status; const hint = $("mStatusHint"); if(status==="proposed") hint.textContent = " • Decidi se accettare."; if(status==="active") hint.textContent = " • Accettata da te. Puoi completarla quando vuoi."; if(status==="skipped") hint.textContent = " • Hai scelto di saltare oggi."; if(status==="completed") hint.textContent = " • Completata (da te)."; $("myState").innerHTML = rec.my.accepted ? <span class="dot ok"></span> Io: accettata : <span class="dot warn"></span> Io: non accettata; const pToday = getPartnerToday(); if(!state.partner){ $("partnerStateToday").innerHTML = <span class="dot warn"></span> Partner: non importato; }else if(!pToday){ $("partnerStateToday").innerHTML = <span class="dot warn"></span> Partner: sconosciuto; }else{ const pa = !!pToday.accepted; const pc = !!pToday.completed; const dot = pc ? "ok" : (pa ? "ok" : "warn"); const txt = pc ? "completata" : (pa ? "accettata" : "non accettata"); $("partnerStateToday").innerHTML = <span class="dot ${dot}"></span> Partner: ${txt}; } $("syncStamp").textContent = state.partner?.lastSyncAt ? Sync: ${new Date(state.partner.lastSyncAt).toLocaleTimeString()} : "Sync: —"; $("btnAcceptToggle").textContent = rec.my.accepted ? "Revoca accettazione" : "Accetta"; $("btnAcceptToggle").disabled = rec.skipped || rec.my.completed; $("btnReplace").disabled = rec.skipped || rec.my.completed; $("btnSkip").disabled = rec.my.completed; $("btnComplete").disabled = !(rec.my.accepted && !rec.skipped && !rec.my.completed); $("completeCard").style.display = "none"; $("cRate").value = ""; $("cNote").value = ""; // favorites renderFavButton(tpl?.id); $("btnFavToday").disabled = !tpl?.id; } function deriveStatus(rec){ let st = "proposed"; if(rec.skipped) st = "skipped"; else if(rec.my.completed) st = "completed"; else if(rec.my.accepted) st = "active"; return st; } function renderHistory(){ const q = ($("histQuery").value || "").trim().toLowerCase(); const stFilter = $("histStatus").value || "all"; const favOnly = $("histFavOnly").checked; const body = $("historyBody"); body.innerHTML = ""; const entries = Object.entries(state.daily || {}) .map(([date, rec]) => ({ date, rec, st: deriveStatus(rec), tpl: getTemplateById(rec.templateId) })) .sort((a,b)=> a.date < b.date ? 1 : -1) .slice(0, 200); const filtered = entries.filter(e=>{ if(stFilter !== "all" && e.st !== stFilter) return false; if(favOnly && !isFav(e.tpl?.id)) return false; if(q){ const title = (e.tpl?.title || "").toLowerCase(); const tags = (e.tpl?.tags || []).join(" ").toLowerCase(); if(!title.includes(q) && !tags.includes(q)) return false; } return true; }); if(!filtered.length){ const tr = document.createElement("tr"); tr.innerHTML = <td colspan="5" class="muted">Nessun risultato.</td>; body.appendChild(tr); return; } for(const e of filtered){ const rating = e.rec.my.rating ? ${e.rec.my.rating}/5 : "—"; const fav = isFav(e.tpl?.id); const tr = document.createElement("tr"); tr.innerHTML = <td> <button class="iconBtn" data-fav="${escapeHtml(e.tpl?.id || "")}" style="padding:8px 10px;"> <svg class="star" viewBox="0 0 24 24" aria-hidden="true"> <path class="${fav ? "starFill" : "starEmpty"}" d="M12 3.2l2.6 5.6 6.1.9-4.4 4.3 1 6.1-5.3-2.9-5.3 2.9 1-6.1-4.4-4.3 6.1-.9L12 3.2z"/> </svg> </button> </td> <td>${e.date}</td> <td> <div><strong>${escapeHtml(e.tpl?.title || "—")}</strong></div> <div class="tiny muted2">${escapeHtml((e.tpl?.tags||[]).join(", "))}</div> </td> <td><span class="badge"><span class="dot ${e.st==="completed"||e.st==="active" ? "ok":"warn"}"></span>${e.st}</span></td> <td class="muted2">${rating}</td> ; body.appendChild(tr); } // bind favorite buttons body.querySelectorAll("[data-fav]").forEach(btn=>{ btn.onclick = ()=>{ const id = btn.getAttribute("data-fav"); if(!id) return; toggleFav(id); renderHistory(); // keep dash in sync if same template renderDash(); }; }); } function renderSettings(){ $("outSync").value = $("outSync").value || ""; $("inSync").value = $("inSync").value || ""; updateThemeState(); } function renderSettingsProfile(){ $("profileMeta").textContent = ${state.me.name || "—"} • intensità ≤ ${clampInt(state.me.intensity,1,5,2)} • codice: ${(state.setup.coupleCode||"").trim() ? "ok" : "—"}; $("profileSaveState").textContent = "—"; $("setMeName").value = state.me.name || ""; $("setMePron").value = state.me.pronouns || ""; $("setMeInt").value = clampInt(state.me.intensity,1,5,2); $("setMeFreq").value = state.me.frequency || "media"; $("setCoupleCode").value = state.setup.coupleCode || ""; $("setMeNotes").value = state.me.notes || ""; pillSet("setInterests", state.me.interests || [], (tag)=>{ const set = new Set(state.me.interests || []); if(set.has(tag)) set.delete(tag); else set.add(tag); state.me.interests = [...set]; state.me.hardLimits = (state.me.hardLimits||[]).filter(x=>x!==tag); saveState(); renderSettingsProfile(); }); pillSet("setLimits", state.me.hardLimits || [], (tag)=>{ const set = new Set(state.me.hardLimits || []); if(set.has(tag)) set.delete(tag); else set.add(tag); state.me.hardLimits = [...set]; state.me.interests = (state.me.interests||[]).filter(x=>x!==tag); saveState(); renderSettingsProfile(); }); } // Sync function buildSyncPayload(includeNotes){ const dailyOut = {}; const dates = Object.keys(state.daily || {}).sort().slice(-14); for(const d of dates){ const r = state.daily[d]; dailyOut[d] = { accepted: !!r.my.accepted, completed: !!r.my.completed, rating: r.my.rating ?? null, note: includeNotes ? (r.my.note || "") : undefined, replaceSalt: r.replaceSalt || 0, skipped: !!r.skipped, acceptedAt: r.my.acceptedAt || null, completedAt: r.my.completedAt || null }; } return { v: 1, coupleCode: (state.setup.coupleCode || "").trim(), updatedAt: new Date().toISOString(), profile: { name: (state.me.name||"").trim(), pronouns: (state.me.pronouns||"").trim(), intensity: clampInt(state.me.intensity,1,5,2), frequency: state.me.frequency || "media", interests: [...(state.me.interests||[])], hardLimits: [...(state.me.hardLimits||[])], notes: includeNotes ? (state.me.notes||"") : "" }, daily: dailyOut }; } function encodePayload(obj){ const json = JSON.stringify(obj); const b64 = btoa(unescape(encodeURIComponent(json))) .replaceAll("+","-").replaceAll("/","_").replaceAll("=",""); return "MC2:" + b64; } function decodePayload(text){ const t = (text||"").trim(); if(!t.startsWith("MC2:")) throw new Error("Formato non valido."); const b64 = t.slice(4).replaceAll("-","+").replaceAll("_","/"); const pad = b64.length % 4 ? "=".repeat(4 - (b64.length % 4)) : ""; const json = decodeURIComponent(escape(atob(b64 + pad))); return JSON.parse(json); } function importPartnerSync(text){ const payload = decodePayload(text); if(payload.v !== 1) throw new Error("Versione sync non supportata."); const myCode = (state.setup.coupleCode||"").trim(); if(!myCode) throw new Error("Prima imposta il Codice Coppia."); if((payload.coupleCode||"").trim() !== myCode) throw new Error("Codice Coppia non corrisponde."); state.partner = { name: payload.profile?.name || "Partner", pronouns: payload.profile?.pronouns || "", intensity: clampInt(payload.profile?.intensity,1,5,2), frequency: payload.profile?.frequency || "media", interests: Array.isArray(payload.profile?.interests) ? payload.profile.interests : [], hardLimits: Array.isArray(payload.profile?.hardLimits) ? payload.profile.hardLimits : [], notes: payload.profile?.notes || "", lastSyncAt: payload.updatedAt || new Date().toISOString(), daily: payload.daily || {} }; const k = todayKey(); const pToday = state.partner.daily?.[k]; if(pToday && typeof pToday.replaceSalt === "number"){ state.daily[k] = state.daily[k] || { templateId:null, replaceSalt:0, skipped:false, my:{accepted:false, completed:false, rating:null, note:"", acceptedAt:null, completedAt:null} }; state.daily[k].replaceSalt = Math.max(state.daily[k].replaceSalt||0, pToday.replaceSalt||0); state.daily[k].templateId = computePickForDate(k, state.daily[k].replaceSalt); } saveState(); } // Events: Wizard $("wizBack").onclick = ()=> showWizardStep(Math.max(1, wizStep-1)); $("wizNext").onclick = ()=>{ if(!validateWizardStep(wizStep)) return; if(wizStep < 4) showWizardStep(wizStep+1); else completeOnboarding(); }; $("wizGenCode").onclick = ()=>{ const rnd = crypto.getRandomValues(new Uint32Array(2)); const code = MC-${rnd[0].toString(16).slice(0,6)}-${rnd[1].toString(16).slice(0,6)}.toUpperCase(); $("wizCoupleCode").value = code; state.setup.coupleCode = code; saveState(); showToast("Codice generato. Usalo su entrambi i dispositivi."); }; $("wizImportPartner").onclick = ()=>{ const txt = $("wizPartnerSync").value.trim(); if(!txt){ showToast("Incolla un Sync code."); return; } try{ importPartnerSync(txt); $("wizPartnerImportState").textContent = Partner importato: ${state.partner?.name || "Partner"}; showToast("Partner importato."); }catch(e){ showToast(e.message || "Import fallito."); } }; // Tabs $("tabToday").onclick = ()=> showPage("pageDash"); $("tabHistory").onclick = ()=> showPage("pageHistory"); $("tabSync").onclick = ()=> showPage("pageSettings"); // Quick actions $("btnQuickShare").onclick = ()=> showPage("pageSettings"); $("btnQuickImport").onclick = ()=> showPage("pageSettings"); // Dash actions $("btnAcceptToggle").onclick = ()=>{ const rec = ensureToday(); if(rec.skipped || rec.my.completed) return; rec.my.accepted = !rec.my.accepted; rec.my.acceptedAt = rec.my.accepted ? new Date().toISOString() : null; saveState(); renderDash(); showToast(rec.my.accepted ? "Missione accettata." : "Accettazione revocata."); }; $("btnReplace").onclick = ()=>{ const k = todayKey(); const rec = ensureToday(); if(rec.skipped || rec.my.completed) return; rec.replaceSalt = (rec.replaceSalt||0) + 1; rec.templateId = computePickForDate(k, rec.replaceSalt); rec.my.accepted = false; rec.my.acceptedAt = null; saveState(); renderDash(); showToast("Missione sostituita. (Consiglio: invia Sync al partner)"); }; $("btnSkip").onclick = ()=>{ const rec = ensureToday(); if(rec.my.completed) return; rec.skipped = true; rec.my.accepted = false; rec.my.acceptedAt = null; saveState(); renderDash(); showToast("Oggi: missione saltata."); }; $("btnComplete").onclick = ()=>{ const rec = ensureToday(); if(!(rec.my.accepted && !rec.skipped && !rec.my.completed)) return; $("completeCard").style.display = "block"; $("cRate").value = ""; $("cNote").value = ""; window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" }); }; $("btnCancelCompletion").onclick = ()=> $("completeCard").style.display = "none"; $("btnSaveCompletion").onclick = ()=>{ const rec = ensureToday(); const rating = $("cRate").value ? clampInt($("cRate").value, 1, 5, null) : null; const note = $("cNote").value.trim(); rec.my.completed = true; rec.my.completedAt = new Date().toISOString(); rec.my.rating = rating; rec.my.note = note; saveState(); $("completeCard").style.display = "none"; renderDash(); showToast("Completamento salvato. (Invia Sync se vuoi aggiornare il partner)"); }; // Fav today $("btnFavToday").onclick = ()=>{ const rec = ensureToday(); const tpl = getTemplateById(rec.templateId); if(!tpl?.id) return; toggleFav(tpl.id); renderFavButton(tpl.id); showToast(isFav(tpl.id) ? "Aggiunta alle preferite." : "Rimossa dalle preferite."); }; // Sync actions $("btnBuildSync").onclick = ()=>{ if(!setupComplete()){ showToast("Config incompleta. Rifai onboarding."); return; } const includeNotes = $("chkShareNotes").checked; const payload = buildSyncPayload(includeNotes); $("outSync").value = encodePayload(payload); showToast("Sync generato."); }; $("btnCopySync").onclick = async ()=>{ const txt = $("outSync").value.trim(); if(!txt){ showToast("Genera prima il Sync."); return; } await navigator.clipboard.writeText(txt); showToast("Copiato negli appunti."); }; $("btnShareSync").onclick = async ()=>{ const txt = $("outSync").value.trim(); if(!txt){ showToast("Genera prima il Sync."); return; } if(navigator.share){ try{ await navigator.share({ title:"Missioni di Coppia — Sync", text: txt }); showToast("Condiviso."); }catch{ showToast("Condivisione annullata."); } }else{ showToast("Condivisione non disponibile: usa Copia."); } }; $("btnImportSync").onclick = ()=>{ const txt = $("inSync").value.trim(); if(!txt){ showToast("Incolla un Sync code."); return; } try{ importPartnerSync(txt); const k = todayKey(); const rec = ensureToday(); rec.templateId = computePickForDate(k, rec.replaceSalt||0); saveState(); showToast("Sync importato. Partner aggiornato."); renderDash(); renderSettingsProfile(); }catch(e){ showToast(e.message || "Import fallito."); } }; $("btnClearIn").onclick = ()=> { $("inSync").value = ""; }; $("btnExport").onclick = ()=>{ const blob = new Blob([JSON.stringify(state, null, 2)], { type:"application/json" }); const url = URL.createObjectURL(blob); const a = document.createElement("a"); a.href = url; a.download = missioni-coppia-backup-${todayKey()}.json; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); showToast("Export creato."); }; $("btnReset").onclick = ()=>{ if(!confirm("Vuoi davvero cancellare tutti i dati su questo browser?")) return; localStorage.removeItem(KEY); state = defaultState(); saveState(); showToast("Dati cancellati."); startOnboarding(true); }; // Profile save $("btnSaveProfile").onclick = ()=>{ state.me.name = $("setMeName").value.trim(); state.me.pronouns = $("setMePron").value.trim(); state.me.intensity = clampInt($("setMeInt").value, 1, 5, 2); state.me.frequency = $("setMeFreq").value; state.setup.coupleCode = $("setCoupleCode").value.trim(); state.me.notes = $("setMeNotes").value.trim(); saveState(); const k = todayKey(); state.daily[k] = state.daily[k] || { templateId:null, replaceSalt:0, skipped:false, my:{accepted:false, completed:false, rating:null, note:"", acceptedAt:null, completedAt:null} }; state.daily[k].templateId = computePickForDate(k, state.daily[k].replaceSalt||0); saveState(); $("profileSaveState").textContent = "Salvato."; renderDash(); renderSettingsProfile(); showToast("Profilo aggiornato."); }; // Rerun wizard $("btnRerunWizard").onclick = ()=> startOnboarding(false); function startOnboarding(force){ if(force){ state.flags.onboarded = false; state.setup = { consent18:false, consentPrivacy:false, coupleCode:"" }; state.me = { name:"", pronouns:"", intensity:2, frequency:"media", interests:[], hardLimits:[], notes:"" }; state.partner = null; state.daily = {}; state.favorites = []; saveState(); } setWizardVisible(true); showWizardStep(1); } // Theme buttons $("btnThemeAuto").onclick = ()=> applyTheme("auto"); $("btnThemeLight").onclick = ()=> applyTheme("light"); $("btnThemeDark").onclick = ()=> applyTheme("dark"); // History filters $("histQuery").addEventListener("input", ()=> renderHistory()); $("histStatus").addEventListener("change", ()=> renderHistory()); $("histFavOnly").addEventListener("change", ()=> renderHistory()); // Helpers function escapeHtml(str){ return String(str||"") .replaceAll("&","&amp;") .replaceAll("<","&lt;") .replaceAll(">","&gt;") .replaceAll('"',"&quot;") .replaceAll("'","&#039;"); } // Init (function init(){ // Theme applyTheme(currentTheme()); // If not onboarded or setup incomplete, show wizard const needsWizard = !state.flags?.onboarded || !setupComplete(); if(needsWizard){ startOnboarding(false); return; } $("bottomNav").style.display = "flex"; ensureToday(); saveState(); showPage("pageDash"); renderDash(); })(); </script> </body> </html>
